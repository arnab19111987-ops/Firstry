#!/usr/bin/env bash
set -euo pipefail
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo .)"

if [[ "${SKIP_FT:-}" == "1" ]]; then
  echo "[ft] WARNING: skipping pre-push (SKIP_FT=1)"; exit 0
fi

# If the repo doesn't opt into parity, skip
[ -f "$REPO_ROOT/ci/parity.lock.json" ] || exit 0

export GIT_HOOK=pre-push
export FT_NO_NETWORK=1
export FT_CI_PARITY_DRYRUN="${FT_CI_PARITY_DRYRUN:-0}"

# Prefer to run the local reproducible parity script
if [ -x "./scripts/ft-ci-local" ]; then
  exec bash -lc './scripts/ft-ci-local'
fi

# Fallback: run the ft pre-commit gate
if [ -x "$REPO_ROOT/.venv-parity/bin/ft" ]; then
  exec "$REPO_ROOT/.venv-parity/bin/ft" pre-commit
elif command -v ft >/dev/null 2>&1; then
  exec ft pre-commit
else
  if [ -x "$REPO_ROOT/.venv-parity/bin/python" ]; then
    . "$REPO_ROOT/.venv-parity/bin/activate"
  fi
  exec python -m firsttry.cli pre-commit
fi
